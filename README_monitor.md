# 遥感推理服务监控系统

## 最新更新 (v2.0)

### 🎨 界面优化
- **响应式布局改进**: 确保组件在不同屏幕尺寸下保持横排布局
- **CSS优化**: 添加了专门的布局类 (`metric-row`, `chart-row`) 来保证组件排列
- **加载状态优化**: 改进了加载动画和状态显示

### ⚡ 性能优化
- **前端缓存机制**: 添加智能缓存，减少不必要的API调用
- **后端缓存系统**: 实现30秒缓存，大幅提升API响应速度
- **并行数据加载**: 页面初始化时并行加载所有数据
- **智能刷新策略**: 只在数据过期时才进行刷新

### 🔧 技术改进
- **端口自动选择**: 启动脚本自动检测可用端口，避免端口冲突
- **环境变量支持**: 支持通过环境变量配置端口
- **缓存管理API**: 提供 `/api/clear-cache` 端点清除缓存
- **错误处理优化**: 改进错误提示和日志记录

### 🆕 新增功能
- **图片上传检测**: 支持用户上传遥感图片进行实时检测
- **检测选项配置**: 可选择检测类别、变化检测、图例生成等选项
- **实时检测进度**: 显示检测进度和状态
- **检测结果展示**: 展示检测结果图片和数据

## 启动方式

### 方法1: 使用启动脚本 (推荐)
```bash
chmod +x start_monitor.sh
./start_monitor.sh
```

### 方法2: 直接启动
```bash
python3 monitor_web.py
```

### 方法3: 指定端口启动
```bash
export MONITOR_PORT=8087
python3 monitor_web.py
```

## 主要功能

### 📊 实时监控
- 系统状态实时显示
- 任务执行状态监控
- 系统统计信息
- 实时日志查看

### 📤 图片上传检测
- **文件上传**: 支持TIF、TIFF、JPG、JPEG、PNG格式
- **检测配置**: 可选择14种地物类别进行检测
- **检测选项**: 变化检测、仅变化检测、图例生成
- **实时进度**: 显示上传和检测进度
- **结果展示**: 检测结果图片和数据可视化

### 📈 数据可视化
- 任务完成趋势图
- 地物分类统计图
- 响应式图表布局

### 📋 历史记录
- 历史任务列表
- 任务详情查看
- 结果文件管理

### 🖼️ 检测结果
- 图片预览和下载
- JSON结果查看
- 批量文件管理

## 性能特性

### 前端优化
- **智能缓存**: 避免重复API调用
- **并行加载**: 同时加载多个数据源
- **条件刷新**: 只在数据过期时刷新
- **响应式设计**: 适配各种屏幕尺寸

### 后端优化
- **内存缓存**: 30秒缓存减少文件系统访问
- **单进程模式**: 避免缓存冲突
- **异步处理**: 提高并发性能
- **错误恢复**: 优雅的错误处理

## 配置说明

### 缓存配置
- 缓存时间: 30秒
- 缓存键: 按API端点分类
- 清除方式: 自动过期或手动清除

### 端口配置
- 默认端口: 8086
- 自动检测: 8086-8090
- 环境变量: MONITOR_PORT

## 故障排除

### 端口冲突
如果遇到端口冲突，启动脚本会自动选择下一个可用端口。

### 缓存问题
如果数据不更新，可以访问 `/api/clear-cache` 清除缓存。

### 性能问题
- 检查网络连接
- 确认文件系统权限
- 查看浏览器控制台错误

## 开发说明

### 添加新的API端点
1. 在 `monitor_web.py` 中添加路由
2. 考虑是否需要缓存
3. 添加错误处理

### 修改前端界面
1. 编辑对应的HTML模板
2. 更新CSS样式
3. 测试响应式布局

### 性能调优
1. 调整缓存时间
2. 优化数据库查询
3. 减少不必要的计算

## 系统架构

```
monitor_web.py          # 监控网站主程序
├── templates/          # HTML模板
│   ├── base.html      # 基础模板
│   ├── index.html     # 实时监控页面
│   └── history.html   # 历史记录页面
├── static/            # 静态文件目录
└── data/              # 数据目录
    ├── logs/          # 系统日志
    ├── detected_result_images/    # 推理结果图片
    └── detected_result_json_files/ # 推理结果JSON文件
```

## 安装和运行

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 启动监控服务

```bash
python monitor_web.py
```

监控网站将在 `http://localhost:8086` 启动。

### 3. 访问监控界面

- **实时监控**: http://localhost:8086/
- **历史记录**: http://localhost:8086/history

## API接口

### 获取当前任务状态
```
GET /api/tasks/current
```

### 获取历史任务记录
```
GET /api/tasks/history
```

### 获取特定任务详情
```
GET /api/tasks/{task_id}
```

### 获取系统日志
```
GET /api/logs?limit=100
```

### 获取系统统计信息
```
GET /api/stats
```

## 配置说明

监控系统会自动读取以下目录的数据：

- **日志目录**: `/data/XXF/new/new_remote_sensing_code/data/logs/`
- **结果图片**: `/data/XXF/new/new_remote_sensing_code/data/detected_result_images/`
- **结果JSON**: `/data/XXF/new/new_remote_sensing_code/data/detected_result_json_files/`

## 功能说明

### 实时监控页面

1. **系统状态卡片**: 显示系统运行状态、总任务数、已完成任务数、处理图片数
2. **当前任务状态**: 显示正在运行的推理任务状态
3. **统计图表**: 任务完成趋势图和地物分类统计图
4. **系统日志**: 实时显示系统运行日志

### 历史记录页面

1. **筛选功能**: 支持按日期、状态、关键词筛选任务
2. **任务列表**: 显示所有历史推理任务
3. **任务详情**: 点击详情可查看完整的推理结果
4. **图片查看**: 支持查看推理结果图片

## 技术栈

- **后端**: FastAPI + Python
- **前端**: Bootstrap 5 + Chart.js + Font Awesome
- **模板引擎**: Jinja2
- **图表库**: Chart.js

## 自定义配置

如需修改数据目录路径，请编辑 `monitor_web.py` 文件中的路径配置：

```python
# 项目路径配置
PROJECT_ROOT = Path("/data/remote_sensing_project")
DATA_DIR = PROJECT_ROOT / "data"
LOGS_DIR = DATA_DIR / "logs"
DETECTED_IMAGES_DIR = DATA_DIR / "detected_result_images"
DETECTED_JSON_DIR = DATA_DIR / "detected_result_json_files"
```

## 故障排除

### 常见问题

1. **无法访问监控网站**
   - 检查端口8086是否被占用
   - 确认防火墙设置

2. **数据不显示**
   - 检查数据目录路径是否正确
   - 确认推理服务是否正常运行

3. **图片无法显示**
   - 检查图片文件路径
   - 确认文件权限设置

### 日志查看

监控系统的日志会输出到控制台，可以通过以下方式查看：

```bash
python monitor_web.py 2>&1 | tee monitor.log
```

## 更新日志

### v1.0.0
- 初始版本发布
- 支持实时监控和历史记录查看
- 集成图表可视化功能
- 支持任务详情和图片查看 